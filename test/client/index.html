<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Client Colyseus</title>
        <script type="text/javascript" src="dist/colyseus.js"></script>
    </head>
    <body>
        <h1>Client Colyseus</h1>
        <p><button onclick="connect()">Connect</button></p>
        <div class="actions">
            <p><button onclick="ping()" disabled>Ping</button></p>
        </div>
        <script type="text/javascript">


            // var id = 0
            // try {
            //     let store = window.sessionStorage
            //     store.id = store.id || Math.round(Math.random() * Math.pow(10, 15))
            //     id = store.id
            // }
            // catch(e) {
            //     console.log('browser storage not available')
            // }

            var idHandler = {

                get: () => {
                    try {
                        let store = window.localStorage
                        return store.id || 0
                    }
                    catch(e) {
                        console.log("browser storage not available")
                    }
                }

                ,set: (id) => {
                    try {
                        let store = window.localStorage
                        store.id = id
                    }
                    catch(e) {
                        console.log("browser storage not available")
                    }
                }

            }

            class Client
            {
                constructor() {
                    this.client;
                    this.gameRoom;
                    this.roomName = "game_room"
                }

                connect() {
                    this.client = new Colyseus.Client('ws://192.168.33.10:8081')

                    this.client.onOpen.add(() => {
                        let id = idHandler.get()
                        console.log(this.client.id, "connected! (previous id: "+id+")")

                        this.gameRoom = this.client.join(this.roomName, {uid: id, score: 0})
                        this.initEvent()

                        idHandler.set(this.client.id)

                        // activate actions
                        var buttons = document.querySelectorAll('.actions button');
                        console.log(buttons);
                        for(let button of buttons) {
                            button.disabled = false
                        }

                    })
                    this.client.onMessage.add((event) => {
                        console.log("Received message:", event)
                    });
                    this.client.onClose.add((event) => {
                        console.log("closing connection...", event)
                        this.client.close()
                    })
                    this.client.onError.add((err) => {
                        console.log("ERROR")
                        console.log(err)
                    })

                    //cf. websocket.js (https://github.com/gamestdio/websocket.js)



                    //this.gameRoom.on('setup') ?
                }

                initEvent () {
                    this.gameRoom.onJoin.add(() => {
                        console.log("ROOM ONJOIN:", this.client.id, "joined", this.roomName)
                    });
                    this.gameRoom.onError.add(() => {
                        console.log("ROOM ONERROR:", this.client.id, "couldn't join", this.roomName)
                    });
                    this.gameRoom.onLeave.add(() => {
                        console.log("ROOM ONLEAVE:", this.client.id, "leaved", this.roomName)
                    });
                    this.gameRoom.onData.add((data) => {
                        console.log("ROOM ONDATA:", this.client.id, "received on", this.roomName+":", data)
                    });
                    /*this.gameRoom.onPatch.add((patches) => {
                        // console.log(typeof patches)
                        // console.log(this.roomName, "will apply these changes:", patches)
                    });*/
                    this.gameRoom.onUpdate.add((newState, patches) => {
                        // console.log(typeof newState)
                        // console.log(this.roomName, "new state", newState, "changes applied:", patches)
                    });
                }

                ping() {
                    this.client.send("Ping")
                }
            }

            var client = new Client()

            var connect = () => {
                client.connect()
            }

            var ping = () => {
                this.client.ping()
            }

        </script>

    </body>
</html>
