<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Client Colyseus</title>
        <script type="text/javascript" src="dist/colyseus.js"></script>
    </head>
    <body>
        <h1>Client Colyseus</h1>
        <button onclick="connect()">Connect</button>
        <script type="text/javascript">


            // var id = 0
            // try {
            //     let store = window.sessionStorage
            //     store.id = store.id || Math.round(Math.random() * Math.pow(10, 15))
            //     id = store.id
            // }
            // catch(e) {
            //     console.log('browser storage not available')
            // }

            var idHandler = {

                get: () => {
                    try {
                        let store = window.localStorage
                        return store.id || 0
                    }
                    catch(e) {
                        console.log("browser storage not available")
                    }
                }

                ,set: (id) => {
                    try {
                        let store = window.localStorage
                        store.id = id
                    }
                    catch(e) {
                        console.log("browser storage not available")
                    }
                }

            }


            var connect = () => {

                var roomName = "game_room"
                var gameRoom

                var client = new Colyseus.Client('ws://192.168.33.10:3000')

                client.onOpen.add(() => {
                    let id = idHandler.get()
                    console.log(client.id, "connected! (previous id: "+id+")")

                    gameRoom = client.join(roomName, {uid: id, score: 0})
                    initEvent()

                    idHandler.set(client.id)

                })
                client.onMessage.add((event) => {
                    console.log("client received message!", event)
                });
                client.onClose.add((event) => {
                    console.log("closing connection...", event)
                    client.close()
                })
                client.onError.add((err) => {
                    console.log("ERROR")
                    console.log(err)
                })

                //cf. websocket.js (https://github.com/gamestdio/websocket.js)

                function initEvent () {
                    gameRoom.onJoin.add(() => {
                        console.log(client.id, "joined", roomName)
                    });
                    gameRoom.onError.add(() => {
                        console.log(client.id, "couldn't join", roomName)
                    });
                    gameRoom.onLeave.add(() => {
                        console.log(client.id, "leaved", roomName)
                    });
                    gameRoom.onData.add((data) => {
                        console.log(client.id, "received on", roomName, ":", data)
                    });
                    /*gameRoom.onPatch.add((patches) => {
                        // console.log(typeof patches)
                        // console.log(roomName, "will apply these changes:", patches)
                    });*/
                    gameRoom.onUpdate.add((newState, patches) => {
                        // console.log(typeof newState)
                        // console.log(roomName, "new state", newState, "changes applied:", patches)
                    });
                }



                //gameRoom.on('setup') ?
            }

        </script>

    </body>
</html>
